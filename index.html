<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>IDE TRANSPORTE PERSONA</title>
  <!-- Carga estilos y librería Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Estilos visuales mejorados para una interfaz profesional */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f8;
      color: #333;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    nav {
      display: flex;
      gap: 15px;
    }
    nav a {
      color: #ecf0f1;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    main {
      padding: 20px;
    }
    h2 {
      color: #2c3e50;
    }
    details {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    details summary {
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 10px;
    }
    form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    form input, form select {
      padding: 8px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-transform: uppercase; /* Mantener mayúsculas */
    }
    form button {
      padding: 10px 20px;
      background-color: #2980b9;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    form button:hover {
      background-color: #1f5f87;
    }
    #controls {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #controls select, #controls input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-transform: uppercase; /* Mayúsculas */
    }
    #controls button {
      padding: 10px 20px;
      background-color: #27ae60;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #controls button i {
      font-size: 1rem;
    }
    #controls button:hover {
      background-color: #1e8449;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eaeaea;
      text-align: left;
      text-transform: uppercase; /* Tabla en mayúsculas */
    }
    th {
      background-color: #34495e;
      color: #ecf0f1;
    }
    td[contenteditable="true"] {
      background-color: #fefbd8;
    }
    #map {
      height: 500px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-map-marker-alt"></i> Editor GeoJSON de Personal</h1>
    <nav>
      <a href="#addForm">Agregar</a>
      <a href="#controls">Filtrar</a>
      <a href="#map">Mapa</a>
    </nav>
  </header>
  <main>
    <!-- Sección de formulario desplegable -->
    <details open>
      <summary><i class="fas fa-user-plus"></i> Agregar nuevo personal</summary>
      <form id="addForm">
        <label>CODIGO: <input type="text" id="CODIGO" required /></label>
        <label>NOMBRE: <input type="text" id="NOMBRE" required /></label>
        <label>RUTA: <input type="text" id="RUTA" /></label>
        <label>CEDULA: <input type="text" id="CEDULA" /></label>
        <label>TELEFONO: <input type="text" id="TELEFONO" /></label>
        <label>DISCAPACIDAD: <input type="text" id="DISCAPACIDAD" /></label>
        <label>TIPO HORARIO: <input type="text" id="TIPO_HORARIO" /></label>
        <label>CARGO: <input type="text" id="CARGO" /></label>
        <label>AREA: <input type="text" id="AREA" /></label>
        <label>MODALIDAD DE CONTRATO: <input type="text" id="MODALIDAD_DE_CONTRATO" /></label>
        <label>DIRECCION: <input type="text" id="DIRECCION" /></label>
        <label>HORARIO: <input type="text" id="HORARIO" /></label>
        <label>LUGAR TRABAJO: <input type="text" id="LUGAR_TRABAJO" /></label>
        <label>LONGITUD: <input type="number" step="any" id="LONGITUD" required /></label>
        <label>LATITUD: <input type="number" step="any" id="LATITUD" required /></label>
        <label>CONTRATO LUZ: <input type="text" id="CONTRATO_LUZ" /></label>
        <label>TRANSPORTE: <input type="text" id="TRANSPORTE" /></label>
        <button type="submit">Agregar</button>
      </form>
    </details>

    <!-- Filtros y descarga -->
    <div id="controls">
      <label for="filterField">Filtrar por:</label>
      <select id="filterField">
        <option value="CODIGO">CODIGO</option>
        <option value="NOMBRE" selected>NOMBRE</option>
      </select>
      <input type="text" id="searchInput" placeholder="Escribe para filtrar..." />
      <button id="downloadBtn"><i class="fas fa-download"></i> Descargar GeoJSON</button>
    </div>

    <div id="map"></div>
    <div id="tableContainer"></div>
  </main>

  <script>
    // Campos tal cual definidos (en mayúsculas y con guiones bajos donde corresponda)
    const campos = [
      "CODIGO","NOMBRE","RUTA","CEDULA","TELEFONO","DISCAPACIDAD",
      "TIPO_HORARIO","CARGO","AREA","MODALIDAD_DE_CONTRATO","DIRECCION",
      "HORARIO","LUGAR_TRABAJO","LONGITUD","LATITUD","CONTRATO_LUZ","TRANSPORTE"
    ];
    let geojsonData = { type: "FeatureCollection", features: [] };

    // Inicializa mapa Leaflet
    let map = L.map('map').setView([0, 0], 2);
    let geojsonLayer = null;

    // Añade capa base
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Carga GeoJSON desde GitHub
    fetch("https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/BASE_DATOS_TRANSPORTE_2025.geojson")
      .then(r => r.json())
      .then(data => {
        geojsonData = data;
        mostrarTabla(geojsonData);
        mostrarMapa(geojsonData);
      });

    // Construye tabla editable
    function mostrarTabla(data) {
      const cont = document.getElementById("tableContainer");
      let html = `<table><thead><tr><th>#</th>`;
      campos.forEach(campo => {
        // Mostrar con espacios en lugar de guiones bajos para el encabezado
        let header = campo.replace(/_/g, " ");
        html += `<th>${header}</th>`;
      });
      html += `</tr></thead><tbody>`;

      data.features.forEach((f, i) => {
        html += `<tr><td>${i + 1}</td>`;
        campos.forEach(campo => {
          const valor = f.properties[campo] || "";
          html += `<td contenteditable="true" data-feature="${i}" data-attr="${campo}">${valor}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      cont.innerHTML = html;

      // Evento para editar directamente en tabla
      cont.querySelectorAll('td[contenteditable="true"]').forEach(td => {
        td.addEventListener('input', e => {
          const fila = e.target.dataset.feature;
          const attr = e.target.dataset.attr;
          let valor = e.target.textContent.trim().toUpperCase();
          geojsonData.features[fila].properties[attr] = valor;

          // Actualizar geometría si es LATITUD o LONGITUD
          if(attr === "LATITUD" || attr === "LONGITUD"){
            let lat = parseFloat(geojsonData.features[fila].properties["LATITUD"]) || 0;
            let lng = parseFloat(geojsonData.features[fila].properties["LONGITUD"]) || 0;
            geojsonData.features[fila].geometry = {
              type: "Point",
              coordinates: [lng, lat]
            };
            // Actualizar marcador en el mapa
            mostrarMapa(geojsonData);
          }
        });
      });
    }

    // Mostrar puntos en el mapa con popup
    function mostrarMapa(data) {
      if (geojsonLayer) {
        map.removeLayer(geojsonLayer);
      }
      geojsonLayer = L.geoJSON(data, {
        onEachFeature: (feature, layer) => {
          let popupContent = "";
          for (const key in feature.properties) {
            const label = key.replace(/_/g, " ");
            popupContent += `<strong>${label}:</strong> ${feature.properties[key]}<br>`;
          }
          layer.bindPopup(popupContent);
        },
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
          radius: 6,
          fillColor: "#0074D9",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        })
      }).addTo(map);

      try {
        map.fitBounds(geojsonLayer.getBounds());
      } catch {
        map.setView([0, 0], 2);
      }
    }

    // Filtrar por código o nombre
    function filtrarDatos() {
      const campo = document.getElementById("filterField").value;
      const texto = document.getElementById("searchInput").value.trim().toLowerCase();

      if (!texto) {
        mostrarTabla(geojsonData);
        mostrarMapa(geojsonData);
        return;
      }

      const filtrados = geojsonData.features.filter(f => {
        return (f.properties[campo] || "").toLowerCase().includes(texto);
      });

      mostrarTabla({ type: "FeatureCollection", features: filtrados });
      mostrarMapa({ type: "FeatureCollection", features: filtrados });
    }

    document.getElementById("searchInput").addEventListener("input", filtrarDatos);
    document.getElementById("filterField").addEventListener("change", filtrarDatos);

    // Agregar nuevo personal desde formulario
    document.getElementById("addForm").addEventListener("submit", e => {
      e.preventDefault();
      const nuevaFeature = {
        type: "Feature",
        properties: {},
        geometry: { type: "Point", coordinates: [0, 0] }
      };

      campos.forEach(campo => {
        const input = document.getElementById(campo);
        let val = input ? input.value.trim().toUpperCase() : "";
        nuevaFeature.properties[campo] = val;
        if(campo === "LATITUD") nuevaFeature.geometry.coordinates[1] = parseFloat(val) || 0;
        if(campo === "LONGITUD") nuevaFeature.geometry.coordinates[0] = parseFloat(val) || 0;
      });

      geojsonData.features.push(nuevaFeature);
      mostrarTabla(geojsonData);
      mostrarMapa(geojsonData);
      e.target.reset();
    });

    // Descargar GeoJSON actualizado
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(geojsonData, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "BASE_DATOS_TRANSPORTE_2025_EDITADO.geojson";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
