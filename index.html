<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IDE TRANSPORTE</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-map-location-dot"></i> IDE TRANSPORTE</h1>
  </header>

  <main>
    <div id="map" style="height: 600px;"></div>

    <section id="filtros">
      <label for="destinoFiltro">Destino:</label>
      <select id="destinoFiltro"></select>

      <label for="rutaFiltro">Ruta:</label>
      <select id="rutaFiltro"></select>

      <label for="horarioFiltro">Horario:</label>
      <select id="horarioFiltro"></select>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-0.2, -78.5], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const rutas = [];
    const grupoRutas = L.layerGroup().addTo(map);

    async function cargarRutas() {
      const indexUrl = 'https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/Rutas_de_SALIDA/index.json';
      const archivos = await fetch(indexUrl).then(r => r.json());

      for (const archivo of archivos) {
        const rutaUrl = `https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/Rutas_de_SALIDA/${archivo}`;
        const datos = await fetch(rutaUrl).then(r => r.json());
        datos.features.forEach(f => {
          f._archivo = archivo;
          rutas.push(f);
        });
      }
      actualizarFiltros();
      mostrarRutas(rutas);
    }

    function mostrarRutas(rutasFiltradas) {
      grupoRutas.clearLayers();
      rutasFiltradas.forEach(f => {
        const capa = L.geoJSON(f, {
          style: { color: '#004d99', weight: 3 },
          onEachFeature: (feature, layer) => {
            const p = feature.properties;
            let popup = `<b>${f._archivo}</b><br>`;
            for (const k in p) popup += `<b>${k}:</b> ${p[k]}<br>`;
            layer.bindPopup(popup);
          }
        });
        grupoRutas.addLayer(capa);
      });
    }

    function actualizarFiltros() {
      const destinos = [...new Set(rutas.map(f => f.properties.DESTINO).filter(Boolean))].sort();
      const horarios = [...new Set(rutas.map(f => f.properties.HORARIO).filter(Boolean))].sort();
      const numerosRuta = [...new Set(rutas.map(f => f.properties.NUMERO_RUTA).filter(Boolean))].sort((a, b) => a - b);

      const destinoFiltro = document.getElementById('destinoFiltro');
      const horarioFiltro = document.getElementById('horarioFiltro');
      const rutaFiltro = document.getElementById('rutaFiltro');

      llenarSelect(destinoFiltro, destinos);
      llenarSelect(horarioFiltro, horarios);
      llenarSelect(rutaFiltro, numerosRuta);

      destinoFiltro.addEventListener('change', filtrarRutas);
      horarioFiltro.addEventListener('change', filtrarRutas);
      rutaFiltro.addEventListener('change', filtrarRutas);
    }

    function llenarSelect(select, valores) {
      select.innerHTML = '<option value="">-- Todos --</option>';
      valores.forEach(v => {
        const op = document.createElement('option');
        op.value = v;
        op.textContent = v;
        select.appendChild(op);
      });
    }

    function filtrarRutas() {
      const destinoVal = document.getElementById('destinoFiltro').value;
      const horarioVal = document.getElementById('horarioFiltro').value;
      const rutaVal = document.getElementById('rutaFiltro').value;

      const filtradas = rutas.filter(f => {
        const p = f.properties;
        return (!destinoVal || p.DESTINO === destinoVal) &&
               (!horarioVal || p.HORARIO === horarioVal) &&
               (!rutaVal || p.NUMERO_RUTA == rutaVal);
      });

      mostrarRutas(filtradas);
    }

    cargarRutas();
  </script>
</body>
</html>
