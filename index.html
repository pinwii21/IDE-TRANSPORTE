<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor GeoJSON de Personal</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f6f8;
      color: #333;
    }
    h1, h2 {
      color: #2c3e50;
    }
    form, #controls {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    label, input, select, button {
      display: block;
      margin-bottom: 12px;
    }
    input, select {
      padding: 8px;
      width: 100%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    #loginSection {
      margin-bottom: 20px;
    }
    #loginBtn {
      background-color: #2980b9;
      color: #fff;
    }
    #logoutBtn {
      background-color: #c0392b;
      color: #fff;
    }
    #controls button, #downloadBtn {
      background-color: #27ae60;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eaeaea;
    }
    th {
      background-color: #34495e;
      color: white;
    }
    td[contenteditable="true"] {
      background-color: #fefbd8;
    }
    #map {
      height: 500px;
      margin-top: 20px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <h1>Editor GeoJSON de Personal</h1>

  <div id="loginSection">
    <label>Usuario: <input type="text" id="usuario" /></label>
    <label>Clave: <input type="password" id="clave" /></label>
    <button id="loginBtn">Iniciar sesión</button>
    <button id="logoutBtn" style="display:none">Cerrar sesión</button>
  </div>

  <form id="addForm" style="display:none">
    <h2>Agregar nuevo personal</h2>
    <div id="camposForm"></div>
    <button type="submit">Agregar Personal</button>
  </form>

  <div id="controls">
    <label for="filterField">Filtrar por:</label>
    <select id="filterField">
      <option value="CODIGO">Código</option>
      <option value="NOMBRE" selected>Nombre</option>
    </select>
    <input type="text" id="searchInput" placeholder="Buscar..." />
    <button id="downloadBtn">Descargar GeoJSON</button>
  </div>

  <div id="map"></div>
  <div id="tabla"></div>

  <script>
    const usuarios = {
      admin: "1234",
      kevin: "admin2025"
    };

    const campos = [
      "CODIGO", "NOMBRE", "RUTA", "CEDULA", "TELEFONO", "DISCAPACIDAD", "TIPO HORARIO",
      "CARGO", "AREA", "MODALIDAD DE CONTRATO", "DIRECCION", "HORARIO", "LUGAR TRABAJO",
      "LONGITUD", "LATITUD", "CONTRATO LUZ", "TRANSPORTE"
    ];

    let geojsonData = null;
    let usuarioLogueado = false;
    let map = L.map("map").setView([0, 0], 2);
    let geojsonLayer;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    // Cargar datos desde GitHub
    fetch("https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/BASE_DATOS_TRANSPORTE_2025.geojson")
      .then(r => r.json())
      .then(data => {
        geojsonData = data;
        mostrarTabla(geojsonData);
        mostrarMapa(geojsonData);
        crearCamposFormulario();
      });

    // Login básico
    document.getElementById("loginBtn").addEventListener("click", () => {
      const usuario = document.getElementById("usuario").value.trim();
      const clave = document.getElementById("clave").value.trim();
      if (usuarios[usuario] && usuarios[usuario] === clave) {
        usuarioLogueado = true;
        document.getElementById("addForm").style.display = "block";
        document.getElementById("logoutBtn").style.display = "inline-block";
        alert("¡Bienvenido!");
      } else {
        alert("Credenciales incorrectas");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      location.reload();
    });

    // Crear formulario dinámico
    function crearCamposFormulario() {
      const cont = document.getElementById("camposForm");
      cont.innerHTML = "";
      campos.forEach(campo => {
        cont.innerHTML += `<label>${campo.replace(/_/g, " ")}: <input type="text" id="${campo}" /></label>`;
      });
    }

    // Mostrar tabla editable
    function mostrarTabla(data) {
      const cont = document.getElementById("tabla");
      if (!data.features) return;
      let html = `<table><thead><tr><th>#</th>`;
      campos.forEach(c => html += `<th>${c}</th>`);
      html += `</tr></thead><tbody>`;
      data.features.forEach((f, i) => {
        html += `<tr><td>${i + 1}</td>`;
        campos.forEach(campo => {
          let valor = f.properties[campo] || "";
          if (campo === "LATITUD" && f.geometry?.coordinates) valor = f.geometry.coordinates[1];
          if (campo === "LONGITUD" && f.geometry?.coordinates) valor = f.geometry.coordinates[0];
          html += `<td ${usuarioLogueado ? 'contenteditable="true"' : ""} data-feature="${i}" data-attr="${campo}">${valor}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      cont.innerHTML = html;

      if(usuarioLogueado){
        document.querySelectorAll('td[contenteditable="true"]').forEach(td => {
          td.addEventListener('input', e => {
            const fila = td.dataset.feature;
            const campo = td.dataset.attr;
            const valor = td.textContent.trim().toUpperCase();
            geojsonData.features[fila].properties[campo] = valor;

            if(campo === "LATITUD" || campo === "LONGITUD"){
              let lat = parseFloat(geojsonData.features[fila].properties["LATITUD"]) || 0;
              let lng = parseFloat(geojsonData.features[fila].properties["LONGITUD"]) || 0;
              geojsonData.features[fila].geometry = {
                type: "Point",
                coordinates: [lng, lat]
              };
              mostrarMapa(geojsonData);
            }
          });
        });
      }
    }

    // Mostrar mapa
    function mostrarMapa(data) {
      if(geojsonLayer) map.removeLayer(geojsonLayer);
      geojsonLayer = L.geoJSON(data, {
        onEachFeature: (f, l) => {
          let html = "";
          for(const key in f.properties){
            html += `<b>${key.replace(/_/g, " ")}:</b> ${f.properties[key]}<br>`;
          }
          l.bindPopup(html);
        },
        pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius: 6, fillColor: "#0074D9", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8
        })
      }).addTo(map);

      try {
        map.fitBounds(geojsonLayer.getBounds());
      } catch {
        map.setView([0, 0], 2);
      }
    }

    // Filtro
    document.getElementById("searchInput").addEventListener("input", filtrarDatos);
    document.getElementById("filterField").addEventListener("change", filtrarDatos);
    function filtrarDatos() {
      const campo = document.getElementById("filterField").value;
      const texto = document.getElementById("searchInput").value.trim().toLowerCase();
      if (!texto) {
        mostrarTabla(geojsonData);
        mostrarMapa(geojsonData);
        return;
      }
      const filtrados = geojsonData.features.filter(f =>
        (f.properties[campo] || "").toLowerCase().includes(texto)
      );
      mostrarTabla({ type: "FeatureCollection", features: filtrados });
      mostrarMapa({ type: "FeatureCollection", features: filtrados });
    }

    // Agregar nuevo personal
    addForm.addEventListener("submit", e => {
      e.preventDefault();
      const nuevaFeature = {
        type: "Feature",
        properties: {},
        geometry: { type: "Point", coordinates: [0, 0] }
      };
      campos.forEach(campo => {
        const input = document.getElementById(campo);
        const val = input ? input.value.trim().toUpperCase() : "";
        nuevaFeature.properties[campo] = val;
        if(campo === "LATITUD") nuevaFeature.geometry.coordinates[1] = parseFloat(val) || 0;
        if(campo === "LONGITUD") nuevaFeature.geometry.coordinates[0] = parseFloat(val) || 0;
      });
      geojsonData.features.push(nuevaFeature);
      mostrarTabla(geojsonData);
      mostrarMapa(geojsonData);
      addForm.reset();
    });

    // Descargar GeoJSON
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(geojsonData, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "BASE_DATOS_TRANSPORTE_2025_EDITADO.geojson";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
