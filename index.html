<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IDE TRANSPORTE</title>

<!-- Hoja de estilos de Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Íconos de FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
  :root {
    /* Variables de color y estilos reutilizables */
    --color-primario: #004d99;
    --color-secundario: #007acc;
    --color-fondo: #f8f9fa;
    --color-texto: #212529;
    --color-blanco: #fff;
    --color-gris-claro: #e9ecef;
    --color-gris-medio: #adb5bd;
    --color-error: #dc3545;
    --color-exito: #28a745;
    --color-hover: #005bb5;
    --borde-radio: 8px;
  }

  * {
    box-sizing: border-box;
  }

  body, html {
    /* Estilo general de la página */
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--color-fondo);
    color: var(--color-texto);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    /* Barra superior fija con login */
    background: var(--color-primario);
    color: var(--color-blanco);
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  #loginForm {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #loginForm input[type="text"],
  #loginForm input[type="password"] {
    /* Campos de usuario y clave */
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    font-size: 0.9rem;
    width: 130px;
  }

  #loginForm button {
    /* Botón de login */
    background-color: var(--color-secundario);
    border: none;
    color: var(--color-blanco);
    padding: 7px 15px;
    font-weight: 600;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.25s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
  }

  #logoutBtn {
    /* Botón de cerrar sesión */
    background-color: var(--color-error);
    display: none;
  }

  main {
    /* Contenedor principal: mapa + panel */
    display: flex;
    height: calc(100vh - 60px);
    padding: 80px 20px 20px 20px;
    gap: 20px;
    overflow: hidden;
  }

  #map {
    /* Contenedor del mapa Leaflet */
    flex: 1.3;
    border-radius: var(--borde-radio);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 320px;
  }

  #panelDerecho {
    /* Panel derecho: controles y tabla */
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--color-blanco);
    border-radius: var(--borde-radio);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 320px;
  }

  #controles {
    /* Filtros y botón de descarga */
    padding: 15px 20px;
    border-bottom: 1px solid var(--color-gris-claro);
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }

  #tabla {
    /* Tabla de datos */
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    min-width: 700px;
  }

  thead tr {
    /* Encabezado de la tabla */
    background-color: var(--color-primario);
    color: var(--color-blanco);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  td[contenteditable="true"] {
    /* Celdas editables */
    background-color: #fffbea;
    cursor: text;
  }

  #addForm {
    /* Formulario de nuevo personal */
    padding: 20px;
    background: var(--color-blanco);
    border-top: 2px solid var(--color-secundario);
    display: none; /* se muestra solo si se inicia sesión */
    border-radius: 0 0 var(--borde-radio) var(--borde-radio);
    box-shadow: inset 0 10px 15px -10px rgba(0,0,0,0.1);
  }

  @media (max-width: 900px) {
    /* Adaptación para móviles */
    main {
      flex-direction: column;
    }
  }
</style>
</head>

<body>
<!-- ENCABEZADO Y FORMULARIO DE LOGIN -->
<header>
  <h1><i class="fa-solid fa-map-location-dot"></i> IDE TRANSPORTE</h1>
  <form id="loginForm" onsubmit="return false;">
    <input id="usuario" type="text" placeholder="Usuario" required />
    <input id="clave" type="password" placeholder="Clave" required />
    <button id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> Entrar</button>
    <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
  </form>
</header>

<!-- CUERPO PRINCIPAL -->
<main>
  <div id="map"></div> <!-- Mapa Leaflet -->

  <section id="panelDerecho">
    <!-- Controles de filtro y descarga -->
    <section id="controles">
      <label for="filterField">Filtrar por:</label>
      <select id="filterField">
        <option value="CODIGO">Código</option>
        <option value="NOMBRE" selected>Nombre</option>
      </select>
      <input type="search" id="searchInput" placeholder="Buscar..." />
      <button id="downloadBtn"><i class="fa-solid fa-download"></i> Descargar</button>
    </section>

    <!-- Tabla con datos del personal -->
    <div id="tabla"></div>
  </section>
</main>

<!-- FORMULARIO PARA NUEVO PERSONAL -->
<form id="addForm">
  <h2><i class="fa-solid fa-user-plus"></i> Agregar nuevo personal</h2>
  <div id="camposForm"></div>
  <button type="submit"><i class="fa-solid fa-plus"></i> Agregar Personal</button>
</form>

<!-- LIBRERÍA LEAFLET -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Usuarios autorizados
  const usuarios = {
    admin: "1234",
    kevin: "admin2025"
  };

  // Lista de campos que tendrá cada registro
  const campos = [
    "CODIGO", "NOMBRE", "RUTA", "CEDULA", "TELEFONO", "DISCAPACIDAD", "TIPO HORARIO",
    "CARGO", "AREA", "MODALIDAD DE CONTRATO", "DIRECCION", "HORARIO", "LUGAR TRABAJO",
    "LONGITUD", "LATITUD", "CONTRATO LUZ", "TRANSPORTE"
  ];

  let geojsonData = null;
  let usuarioLogueado = false;

  // Inicialización del mapa
  let map = L.map("map").setView([-0.180653, -78.467838], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap"
  }).addTo(map);

  // Centrar mapa según datos GeoJSON
  function centrarMapaSegunDatos(data) {
    if (!data.features?.length) return;
    const coords = data.features
      .filter(f => f.geometry?.coordinates?.length === 2)
      .map(f => f.geometry.coordinates);
    const bounds = [[Math.min(...coords.map(c => c[1])), Math.min(...coords.map(c => c[0]))],
                    [Math.max(...coords.map(c => c[1])), Math.max(...coords.map(c => c[0]))]];
    map.fitBounds(bounds, {padding: [40, 40]});
  }

  // Carga el GeoJSON desde GitHub
  fetch("https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/BASE_DATOS_TRANSPORTE_2025.geojson")
    .then(r => r.json())
    .then(data => {
      data.features.forEach((f, i) => f._id = i); // identificador único
      geojsonData = data;
      mostrarTabla(geojsonData);
      mostrarMapa(geojsonData);
      centrarMapaSegunDatos(geojsonData);
      crearCamposFormulario();
    });

  // Genera los campos del formulario
  function crearCamposFormulario() {
    const cont = document.getElementById("camposForm");
    campos.forEach(campo => {
      const label = document.createElement("label");
      label.textContent = campo.replace(/_/g, " ") + ":";
      const input = document.createElement("input");
      input.type = "text";
      input.id = campo;
      input.required = ["CODIGO", "NOMBRE", "LATITUD", "LONGITUD"].includes(campo);
      label.appendChild(input);
      cont.appendChild(label);
    });
  }

  // Muestra tabla editable
  function mostrarTabla(data) {
    const cont = document.getElementById("tabla");
    let html = `<table><thead><tr><th>#</th>`;
    campos.forEach(c => html += `<th>${c}</th>`);
    html += `</tr></thead><tbody>`;
    data.features.forEach((f, i) => {
      html += `<tr><td>${i + 1}</td>`;
      campos.forEach(campo => {
        let valor = f.properties[campo] || "";
        if (campo === "LATITUD") valor = f.geometry.coordinates[1];
        if (campo === "LONGITUD") valor = f.geometry.coordinates[0];
        html += `<td ${usuarioLogueado ? 'contenteditable="true"' : ''} data-feature-id="${f._id}" data-attr="${campo}">${valor}</td>`;
      });
      html += `</tr>`;
    });
    html += `</tbody></table>`;
    cont.innerHTML = html;
    if (usuarioLogueado) asignarEventosEdicion();
  }

  // Permite editar celdas
  function asignarEventosEdicion() {
    document.querySelectorAll('td[contenteditable="true"]').forEach(td => {
      td.addEventListener("input", () => {
        const id = parseInt(td.dataset.featureId);
        const campo = td.dataset.attr;
        const val = td.textContent.trim().toUpperCase();
        const feature = geojsonData.features.find(f => f._id === id);
        feature.properties[campo] = val;
        if (campo === "LATITUD" || campo === "LONGITUD") {
          feature.geometry = {
            type: "Point",
            coordinates: [
              parseFloat(feature.properties["LONGITUD"]),
              parseFloat(feature.properties["LATITUD"])
            ]
          };
          mostrarMapa(geojsonData);
          centrarMapaSegunDatos(geojsonData);
        }
      });
    });
  }

  // Muestra el mapa
  function mostrarMapa(data) {
    if (geojsonLayer) map.removeLayer(geojsonLayer);
    geojsonLayer = L.geoJSON(data, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius: 6,
        fillColor: varColorPrimario(),
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      }),
      onEachFeature: (feature, layer) => {
        let popup = '';
        for (const key in feature.properties) {
          popup += `<b>${key}:</b> ${feature.properties[key]}<br>`;
        }
        layer.bindPopup(popup);
      }
    }).addTo(map);
  }

  // Obtiene el color primario desde CSS
  function varColorPrimario() {
    return getComputedStyle(document.documentElement).getPropertyValue('--color-primario').trim();
  }

  // Filtrar por campo y valor
  document.getElementById("searchInput").addEventListener("input", filtrarDatos);
  document.getElementById("filterField").addEventListener("change", filtrarDatos);

  function filtrarDatos() {
    const campo = document.getElementById("filterField").value;
    const texto = document.getElementById("searchInput").value.trim().toLowerCase();
    const filtrados = geojsonData.features.filter(f =>
      (f.properties[campo] || "").toLowerCase().includes(texto)
    );
    mostrarTabla({type: "FeatureCollection", features: filtrados});
    mostrarMapa({type: "FeatureCollection", features: filtrados});
    centrarMapaSegunDatos({type: "FeatureCollection", features: filtrados});
  }

  // Agregar nuevo personal desde formulario
  document.getElementById("addForm").addEventListener("submit", e => {
    e.preventDefault();
    const nuevo = {
      type: "Feature",
      properties: {},
      geometry: {type: "Point", coordinates: [0, 0]}
    };
    for (const campo of campos) {
      const val = document.getElementById(campo).value.trim().toUpperCase();
      nuevo.properties[campo] = val;
      if (campo === "LONGITUD") nuevo.geometry.coordinates[0] = parseFloat(val) || 0;
      if (campo === "LATITUD") nuevo.geometry.coordinates[1] = parseFloat(val) || 0;
    }
    nuevo._id = geojsonData.features.length;
    geojsonData.features.push(nuevo);
    mostrarTabla(geojsonData);
    mostrarMapa(geojsonData);
    centrarMapaSegunDatos(geojsonData);
    e.target.reset();
  });

  // Descargar archivo GeoJSON
  document.getElementById("downloadBtn").addEventListener("click", () => {
    const dataStr = JSON.stringify(geojsonData, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "datos_personal.geojson";
    a.click();
    URL.revokeObjectURL(url);
  });

  // Login y logout
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const addForm = document.getElementById("addForm");
  const usuarioInput = document.getElementById("usuario");
  const claveInput = document.getElementById("clave");

  loginBtn.addEventListener("click", () => {
    const user = usuarioInput.value.trim();
    const pass = claveInput.value.trim();
    if (usuarios[user] === pass) {
      usuarioLogueado = true;
      alert(`¡Bienvenido, ${user}!`);
      addForm.style.display = "block";
      logoutBtn.style.display = "flex";
      loginBtn.style.display = "none";
      usuarioInput.disabled = true;
      claveInput.disabled = true;
      mostrarTabla(geojsonData);
    } else {
      alert("Usuario o contraseña incorrectos.");
    }
  });

  logoutBtn.addEventListener("click", () => {
    usuarioLogueado = false;
    addForm.style.display = "none";
    logoutBtn.style.display = "none";
    loginBtn.style.display = "flex";
    usuarioInput.disabled = false;
    claveInput.disabled = false;
    usuarioInput.value = "";
    claveInput.value = "";
    mostrarTabla(geojsonData);
  });
</script>
</body>
</html>

