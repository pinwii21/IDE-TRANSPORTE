// Cuando cargamos datos, aÃ±adimos _id a cada feature para mantener referencia original
fetch("https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/BASE_DATOS_TRANSPORTE_2025.geojson")
  .then(r => r.json())
  .then(data => {
    // Agregar _id
    data.features.forEach((f, i) => f._id = i);
    geojsonData = data;
    mostrarTabla(geojsonData);
    mostrarMapa(geojsonData);
    crearCamposFormulario();
  });

// Mostrar tabla
function mostrarTabla(data) {
  const cont = document.getElementById("tabla");
  if (!data.features) return;
  let html = `<table><thead><tr><th>#</th>`;
  campos.forEach(c => html += `<th>${c}</th>`);
  html += `</tr></thead><tbody>`;

  data.features.forEach((f, i) => {
    // Usamos f._id para identificar feature original
    html += `<tr><td>${i + 1}</td>`;
    campos.forEach(campo => {
      let valor = f.properties[campo] || "";
      if (campo === "LATITUD" && f.geometry?.coordinates) valor = f.geometry.coordinates[1];
      if (campo === "LONGITUD" && f.geometry?.coordinates) valor = f.geometry.coordinates[0];
      html += `<td ${usuarioLogueado ? 'contenteditable="true"' : ""} data-feature-id="${f._id}" data-attr="${campo}">${valor}</td>`;
    });
    html += `</tr>`;
  });

  html += `</tbody></table>`;
  cont.innerHTML = html;

  if(usuarioLogueado){
    asignarEventosEdicion();
  }
}

// Editar celdas
function asignarEventosEdicion(){
  const tdsEditables = document.querySelectorAll('td[contenteditable="true"]');
  tdsEditables.forEach(td => td.oninput = null); // eliminar eventos previos

  let timeoutId = null;
  tdsEditables.forEach(td => {
    td.addEventListener('input', () => {
      const featureId = parseInt(td.dataset.featureId);
      const campo = td.dataset.attr;
      const valor = td.textContent.trim().toUpperCase();

      // Encontrar la feature original por _id
      const feature = geojsonData.features.find(f => f._id === featureId);
      if (!feature) return;

      feature.properties[campo] = valor;

      if(campo === "LATITUD" || campo === "LONGITUD"){
        let lat = parseFloat(feature.properties["LATITUD"]) || 0;
        let lng = parseFloat(feature.properties["LONGITUD"]) || 0;

        feature.geometry = {
          type: "Point",
          coordinates: [lng, lat]
        };

        if(timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          mostrarMapa(geojsonData);
        }, 300);
      }
    });
  });
}
