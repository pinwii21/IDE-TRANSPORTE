<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>IDE TRANSPORTE</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --main-color: #2c3e50;
      --accent-color: #27ae60;
      --light-bg: #f4f6f8;
      --form-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-bg);
      color: var(--main-color);
    }

    header {
      background-color: var(--main-color);
      color: white;
      padding: 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      display: grid;
      gap: 20px;
    }

    .card {
      background: var(--form-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }

    input, select {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #219150;
    }

    .btn-danger {
      background-color: #c0392b;
    }

    #map {
      height: 500px;
      border-radius: 10px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #e0e0e0;
    }

    th {
      background-color: var(--main-color);
      color: white;
    }

    td[contenteditable="true"] {
      background-color: #fefbd8;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1><i class="fa-solid fa-map-location-dot"></i> IDE TRANSPORTE</h1>
  </header>

  <div class="container">
    <div class="card" id="loginSection">
      <label>Usuario: <input type="text" id="usuario" /></label>
      <label>Clave: <input type="password" id="clave" /></label>
      <div class="form-inline">
        <button id="loginBtn"><i class="fa-solid fa-right-to-bracket"></i> Iniciar sesión</button>
        <button id="logoutBtn" class="btn-danger hidden"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
      </div>
    </div>

    <form id="addForm" class="card hidden">
      <h2><i class="fa-solid fa-user-plus"></i> Agregar nuevo personal</h2>
      <div id="camposForm"></div>
      <button type="submit"><i class="fa-solid fa-plus"></i> Agregar Personal</button>
    </form>

    <div class="card" id="controls">
      <label for="filterField">Filtrar por:</label>
      <select id="filterField">
        <option value="CODIGO">Código</option>
        <option value="NOMBRE" selected>Nombre</option>
      </select>
      <input type="text" id="searchInput" placeholder="Buscar..." />
      <button id="downloadBtn"><i class="fa-solid fa-download"></i> Descargar GeoJSON</button>
    </div>

    <div id="map" class="card"></div>
    <div id="tabla" class="card"></div>
  </div>

  <script>
    const usuarios = {
      admin: "1234",
      kevin: "admin2025"
    };

    const campos = [
      "CODIGO", "NOMBRE", "RUTA", "CEDULA", "TELEFONO", "DISCAPACIDAD", "TIPO HORARIO",
      "CARGO", "AREA", "MODALIDAD DE CONTRATO", "DIRECCION", "HORARIO", "LUGAR TRABAJO",
      "LONGITUD", "LATITUD", "CONTRATO LUZ", "TRANSPORTE"
    ];

    let geojsonData = null;
    let usuarioLogueado = false;
    let map = L.map("map").setView([0, 0], 2);
    let geojsonLayer;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    fetch("https://raw.githubusercontent.com/pinwii21/IDE-TRANSPORTE/main/BASE_DATOS_TRANSPORTE_2025.geojson")
      .then(r => r.json())
      .then(data => {
        geojsonData = data;
        mostrarTabla(geojsonData);
        mostrarMapa(geojsonData);
        crearCamposFormulario();
      });

    document.getElementById("loginBtn").addEventListener("click", () => {
      const usuario = document.getElementById("usuario").value.trim();
      const clave = document.getElementById("clave").value.trim();
      if (usuarios[usuario] && usuarios[usuario] === clave) {
        usuarioLogueado = true;
        document.getElementById("addForm").classList.remove("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");
        alert("¡Bienvenido!");
      } else {
        alert("Credenciales incorrectas");
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      location.reload();
    });

    function crearCamposFormulario() {
      const cont = document.getElementById("camposForm");
      cont.innerHTML = "";
      campos.forEach(campo => {
        cont.innerHTML += `<label>${campo.replace(/_/g, " ")}: <input type="text" id="${campo}" /></label>`;
      });
    }

    function mostrarTabla(data) {
      const cont = document.getElementById("tabla");
      if (!data.features) return;
      let html = `<table><thead><tr><th>#</th>`;
      campos.forEach(c => html += `<th>${c}</th>`);
      html += `</tr></thead><tbody>`;
      data.features.forEach((f, i) => {
        html += `<tr><td>${i + 1}</td>`;
        campos.forEach(campo => {
          let valor = f.properties[campo] || "";
          if (campo === "LATITUD" && f.geometry?.coordinates) valor = f.geometry.coordinates[1];
          if (campo === "LONGITUD" && f.geometry?.coordinates) valor = f.geometry.coordinates[0];
          html += `<td ${usuarioLogueado ? 'contenteditable="true"' : ""} data-feature="${i}" data-attr="${campo}">${valor}</td>`;
        });
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      cont.innerHTML = html;

      if(usuarioLogueado){
        document.querySelectorAll('td[contenteditable="true"]').forEach(td => {
          td.addEventListener('input', () => {
            const fila = td.dataset.feature;
            const campo = td.dataset.attr;
            const valor = td.textContent.trim().toUpperCase();
            geojsonData.features[fila].properties[campo] = valor;

            if(campo === "LATITUD" || campo === "LONGITUD"){
              let lat = parseFloat(geojsonData.features[fila].properties["LATITUD"]) || 0;
              let lng = parseFloat(geojsonData.features[fila].properties["LONGITUD"]) || 0;
              geojsonData.features[fila].geometry = {
                type: "Point",
                coordinates: [lng, lat]
              };
              mostrarMapa(geojsonData);
            }
          });
        });
      }
    }

    function mostrarMapa(data) {
      if(geojsonLayer) map.removeLayer(geojsonLayer);
      geojsonLayer = L.geoJSON(data, {
        onEachFeature: (f, l) => {
          let html = "";
          for(const key in f.properties){
            html += `<b>${key.replace(/_/g, " ")}:</b> ${f.properties[key]}<br>`;
          }
          l.bindPopup(html);
        },
        pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius: 6, fillColor: "#0074D9", color: "#000", weight: 1, opacity: 1, fillOpacity: 0.8
        })
      }).addTo(map);

      try {
        map.fitBounds(geojsonLayer.getBounds());
      } catch {
        map.setView([0, 0], 2);
      }
    }

    document.getElementById("searchInput").addEventListener("input", filtrarDatos);
    document.getElementById("filterField").addEventListener("change", filtrarDatos);
    function filtrarDatos() {
      const campo = document.getElementById("filterField").value;
      const texto = document.getElementById("searchInput").value.trim().toLowerCase();
      if (!texto) {
        mostrarTabla(geojsonData);
        mostrarMapa(geojsonData);
        return;
      }
      const filtrados = geojsonData.features.filter(f =>
        (f.properties[campo] || "").toLowerCase().includes(texto)
      );
      mostrarTabla({ type: "FeatureCollection", features: filtrados });
      mostrarMapa({ type: "FeatureCollection", features: filtrados });
    }

    addForm.addEventListener("submit", e => {
      e.preventDefault();
      const nuevaFeature = {
        type: "Feature",
        properties: {},
        geometry: { type: "Point", coordinates: [0, 0] }
      };
      campos.forEach(campo => {
        const input = document.getElementById(campo);
        const val = input ? input.value.trim().toUpperCase() : "";
        nuevaFeature.properties[campo] = val;
        if(campo === "LATITUD") nuevaFeature.geometry.coordinates[1] = parseFloat(val) || 0;
        if(campo === "LONGITUD") nuevaFeature.geometry.coordinates[0] = parseFloat(val) || 0;
      });
      geojsonData.features.push(nuevaFeature);
      mostrarTabla(geojsonData);
      mostrarMapa(geojsonData);
      addForm.reset();
    });

    document.getElementById("downloadBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(geojsonData, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "BASE_DATOS_TRANSPORTE_2025_EDITADO.geojson";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>

</body>
</html>
